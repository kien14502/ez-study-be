name: CD â€” Docker Build & Deploy

on:
  push:
    branches:
      - main

env:
  COMPOSE_FILE: docker-compose.prod.yml

jobs:
  docker-build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Deploy with Docker Compose
        run: |
          docker compose -f ${{ env.COMPOSE_FILE }} down --remove-orphans
          docker compose -f ${{ env.COMPOSE_FILE }} up -d --build --force-recreate

      - name: Show deployment status
        run: |
          docker compose -f ${{ env.COMPOSE_FILE }} ps
          docker compose -f ${{ env.COMPOSE_FILE }} logs --tail=50 app

      - name: Cleanup
        run: docker system prune -af --volumes
