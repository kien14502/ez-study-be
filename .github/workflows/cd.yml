name: CD â€” Docker Build & Deploy

on:
  push:
    branches:
      - main

env:
  COMPOSE_FILE: docker-compose.prod.yml

jobs:
  docker-build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Create .env file from GitHub Secrets
        run: |
          cat > .env << EOF
          # App Configuration
          NODE_ENV=production
          PORT=${{ secrets.PORT }}
          APP_GLOBAL_PREFIX=${{ secrets.APP_GLOBAL_PREFIX }}
          CORS_WHITELIST=${{ secrets.CORS_WHITELIST }}

          REDIS_HOST=${{ secrets.REDIS_HOST }}
          REDIS_PORT=${{ secrets.REDIS_PORT }}

          # JWT Configuration
          JWT_ACCESS_SECRET=${{ secrets.JWT_ACCESS_SECRET }}
          JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
          JWT_ACCESS_TOKEN_EXPIRY=${{ secrets.JWT_ACCESS_TOKEN_EXPIRY }}
          JWT_REFRESH_TOKEN_EXPIRY=${{ secrets.JWT_REFRESH_TOKEN_EXPIRY }}

          # Email Configuration
          EMAIL_PASS=${{ secrets.EMAIL_PASS }}
          EMAIL_USER=${{ secrets.EMAIL_USER }}
          EMAIL_HOST=${{ secrets.EMAIL_HOST }}
          EMAIL_PORT=${{ secrets.EMAIL_PORT }}
          CLIENT_URL=${{ secrets.CLIENT_URL }}
          THROTTLE_TTL=${{ secrets.THROTTLE_TTL }}
          THROTTLE_LIMIT=${{ secrets.THROTTLE_LIMIT }}



          EOF

          echo "âœ… .env file created from GitHub Secrets"

      - name: Deploy with Docker Compose
        run: |
          docker compose -f ${{ env.COMPOSE_FILE }} down --remove-orphans || true
          docker compose -f ${{ env.COMPOSE_FILE }} up -d --build --force-recreate

      - name: Wait for services to be healthy
        run: |
          echo "â³ Waiting for services to be healthy..."
          timeout 120 sh -c 'until docker compose -f ${{ env.COMPOSE_FILE }} ps | grep -q "healthy"; do sleep 2; done' || echo "âš ï¸  Warning: Some services may not be healthy yet"

      - name: Show deployment status
        run: |
          echo "=== ðŸ“Š Services Status ==="
          docker compose -f ${{ env.COMPOSE_FILE }} ps
          echo ""
          echo "=== ðŸ“ App Logs (last 50 lines) ==="
          docker compose -f ${{ env.COMPOSE_FILE }} logs --tail=50 app

      - name: Cleanup
        run: |
          echo "ðŸ§¹ Cleaning up unused Docker resources..."
          docker image prune -af
          docker network prune -f
          rm -f .env
          echo "âœ… Cleanup completed"
      - name: Deployment Summary
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… ========================================="
            echo "âœ…  Deployment Successful!"
            echo "âœ… ========================================="
            echo "ðŸ“ App is running at: http://localhost:4000"
            echo "ðŸ“ Kafka UI: http://localhost:8080"
          else
            echo "âŒ ========================================="
            echo "âŒ  Deployment Failed!"
            echo "âŒ ========================================="
            echo "ðŸ“‹ Check logs above for details"
          fi
