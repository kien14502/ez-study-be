name: CD â€” Docker Build & Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  COMPOSE_FILE: docker-compose.prod.yml

jobs:
  docker-build-and-deploy:
    runs-on: self-hosted
    environment: product

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Verify secrets are available
        run: |
          echo "ðŸ” Verifying GitHub Secrets..."

          MISSING_SECRETS=""

          # Check each required secret
          [ -z "${{ secrets.PORT }}" ] && MISSING_SECRETS="$MISSING_SECRETS PORT"
          if [ ! -z "$MISSING_SECRETS" ]; then
            echo "âŒ Missing required secrets:$MISSING_SECRETS"
            echo ""
            echo "Please add these secrets in GitHub:"
            echo "Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret"
            exit 1
          fi

          echo "âœ… All required secrets are configured"

      - name: Create .env file from GitHub Secrets
        run: |
          cat > .env << EOF
          # App Configuration
          NODE_ENV=production
          PORT=${{ secrets.PORT }}

          # JWT Configuration
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN=${{ secrets.JWT_EXPIRES_IN }}

          # Email Configuration
          SMTP_HOST=${{ secrets.SMTP_HOST }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}
          SMTP_USER=${{ secrets.SMTP_USER }}
          SMTP_PASS=${{ secrets.SMTP_PASS }}

          # AWS Configuration (if you use S3 for file uploads)
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION=${{ secrets.AWS_REGION }}
          AWS_BUCKET_NAME=${{ secrets.AWS_BUCKET_NAME }}

          # Other API Keys
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}

          # Payment Gateway (if needed)
          STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
          EOF

          echo "âœ… .env file created from GitHub Secrets"

      - name: Deploy with Docker Compose
        run: |
          docker compose -f ${{ env.COMPOSE_FILE }} down --remove-orphans || true
          docker compose -f ${{ env.COMPOSE_FILE }} up -d --build --force-recreate

      - name: Wait for services to be healthy
        run: |
          echo "â³ Waiting for services to be healthy..."
          timeout 120 sh -c 'until docker compose -f ${{ env.COMPOSE_FILE }} ps | grep -q "healthy"; do sleep 2; done' || echo "âš ï¸  Warning: Some services may not be healthy yet"

      - name: Show deployment status
        run: |
          echo "=== ðŸ“Š Services Status ==="
          docker compose -f ${{ env.COMPOSE_FILE }} ps
          echo ""
          echo "=== ðŸ“ App Logs (last 50 lines) ==="
          docker compose -f ${{ env.COMPOSE_FILE }} logs --tail=50 app

      - name: Cleanup
        run: |
          echo "ðŸ§¹ Cleaning up unused Docker resources..."
          docker image prune -af
          docker network prune -f
          echo "âœ… Cleanup completed"
      - name: Deployment Summary
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… ========================================="
            echo "âœ…  Deployment Successful!"
            echo "âœ… ========================================="
            echo "ðŸ“ App is running at: http://localhost:4000"
            echo "ðŸ“ Kafka UI: http://localhost:8080"
          else
            echo "âŒ ========================================="
            echo "âŒ  Deployment Failed!"
            echo "âŒ ========================================="
            echo "ðŸ“‹ Check logs above for details"
          fi
